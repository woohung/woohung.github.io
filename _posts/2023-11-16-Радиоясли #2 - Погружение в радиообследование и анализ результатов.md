---
layout: post
title: "Радиоясли #2 - Погружение в радиообследование и анализ результатов"
date: '2023/11/16|10:00'
categories: [Wireless]
tags: [Wi-Fi, Радиообследование]
published: true
author: Artem Kovalchuk
---

<img src="https://woohung.github.io/assets/images/wireless_survey_2/wireless_2.png">

<figure>
    <img src="/assets/images/wireless_survey_1/pain.png"
         alt="notebook">
    <figcaption>Без мам, пап и кредитов! (фото Максима Гетмана).</figcaption>
</figure>

![flush](/assets/images/wireless_survey_1/5BF0.gif)

Приветствую, друг!  

В предыдущей части мы прошлись по минимальному сетапу для радиообследования и получили исходную документацию от заказчика. В этой части речь пойдет про непосредственно процесс радиообследования. О базовой работе с сайдкиком, методе APoS и попытках окунуться в анализ спектра.  

> Материал не является руководством к действию, а всего лишь отражает личный опыт автора. Описанное ниже не заменит учебника CWNA и пр. или полноценный курс от эксперта-практика по дизайну и радиообследованию беспроводных сетей.  

- [План работ](#plan)
- [Радиообследование](#survey)
    - [Первичный осмотр](#first-thing)
        - [Результаты осмотра](#results)
    - [Проводим замеры](#measurement)
        - [Гибридный метод обследования](#hybrid)
        - [Основы работы с сайдкиком](#side)
        - [Замеряем](#measuring)
    - [Анализируем данные](#analyse-data)
        - [Первый взгляд на результаты](first-look)
        - [Пример анализа](example-analyse)
    - [Помехи и спектр](#spectrum)
        - [Практическая теория, взгляд дилетанта](#practical-theory)
        - [Сигнатуры](#signatures)
        - [Пример спектрального анализа](#example-spectrum)

# План работ
Перед тем как начать моделировать БСПД, необходимо обратиться к радиообследованию. Некоторые инженеры осознанно опускают этот этап и вполне себе делают проекты без него. Зачем же его тогда делать?  

Основная задача - составить полную картину происходящего в РЧ эфире объекта, а не слепо следовать общим требованиям, например по принципу "одна точка на помещение”.  

> Я понимал, что моего опыта недостаточно на такой проект, поэтому решил попросить совета у автора статей, на которые я уже ссылался ранее, [Максима Гетмана](https://habr.com/ru/users/nuearth/). Все началось с запроса послушать его курс в онлайне, а получилось так, что мы заключили договор на консультации и один полный день активного присутствия на объекте. Забегая вперед, решение привлечь эксперта на начальном этапе помогло избежать с десяток подводных камней. Этим опытом, в том числе, я и делюсь тут.

С планом грядущих работ можно ознакомиться под спойлером. А я сразу перейду к интересному.  

<details>
	<summary><b>Картина работ крупными мазками</b></summary>
        <p>Ниже примерный список действий, которые нам предстоит сделать:</p>
        <ul>
        <li>начнем с первичного осмотра, после которого у нас будет четкая картина объекта;</li>
        <li>затем проведем замеры на основе существующей сети в связке с методом ApoS;</li>
        <li>немного позже отдельно исследуем AP от Qtech, по причине отсутствия этих точек доступа в программе Ekahau Ai Pro. Это обстоятельство добавило условностей и ограничений при построении модели;</li>
        <li>после проведения радиообследования изучим полученные данные, отдельно уделю внимание радиочастотному спектру;</li>
        <li>спроектируем AP на модели в соответствии с полученными данными;</li>
        <li>по результатам радиообследования и моделирования сформируем отчет, требования для монтажа и спецификацию будущих AP;</li>
        </ul>
        <blockquote>
        <p>Согласно ТЗ, проектом СКС занимается сетевой департамент, поэтому в этом цикле я не буду подробно описывать этот этап.</p>
        </blockquote>
        <ul>
        <li>Ближе к началу монтажа прибудет поставка с оборудованием. Этот аспект требует дополнительного мониторинга т.к в цепочке участвует несколько сторон и департаментов. Велика вероятность что-то упустить из виду и потерять время;</li>
        </ul>
        <p>Qtech – не шибко энтерпрайз, по части беспроводных технологий, поэтому было принято решение собрать лабораторный стенд из контроллера, трех AP и домена с необходимым сервисами для имитации корпоративной инфраструктуры. Тут надо отдать должное инженеру контроллера Wimark, который согласился посодействовать нашим экспериментам. Спасибо, Даниил!</p>
        <ul>
        <li><p>Сроки на реализацию около двух месяцев, поэтому было решено запускать систему поэтажно. Как только монтажники сдали этаж, мы сразу берем его в настройку. Также сразу планируется проведение проверочного радиообследования по каждому этажу, чтобы вовремя обнаружить ошибки проектирования и принять меры;</p>
        </li>
        <li><p>после запуска всей системы проводим финальное радиообследование.</p>
        </li>
        </ul>
</details>

# Радиообследование
## Первичный осмотр

После получения поэтажных планов крайне желательно найти время с ними ознакомиться **до** визита на объект.  

Цель первичного осмотра - собрать как можно больше информации об объекте и окружающей среде. Простое правило для будущей прогнозируемой модели - чем больше знаем, тем точнее получится модель.  

Несколько пунктов, которые необходимо выяснить во время осмотра:  
1. Соответствие планов этажей и текущей планировки. Если объект большой, а планы старые, пару участков вы непременно обнаружите;  
2. Помечать на карте недостающие параметры: номера/литеры секций, изменения в планировке, габариты комнат. Все это благотворно скажется на ориентировании на местности;  
3. Для будущей модели нам необходимо понимать из каких материалов состоят ограждающие конструкции, хотя бы примерно;  
4. Отметить потенциальные зоны, где Wi-Fi покрытие не потребуется;  
5. Существующие точки доступа и их монтаж. Тут можно делать фотографию и помечать расположение точки на карте и ее модель.  

В пункте 5 я совершил первую ошибку - делал мало фотографий и недостаточно их документировал (подписывал что есть что). Это потребовало дополнительных поездок на объект. Спасибо Максиму, у него была возможность делать заметки напрямую в IPhone в ПО Ekahau, используя камеру смартфона. Позже я воспользовался похожим способом, применив костыльные техники.  

> **Совет:** Не стесняйтесь делать множество заметок и фотографий по любому сомнению или потенциальному вопросу. Пригодится на последующих этапах.

После завершения осмотра, уточняем у координатора (обычно он есть, либо напрямую у заказчика) наличие дополнительной документации исходя из пунктов выше:  
- Проектные планы этажей с ремонтом, если выяснится, что есть зоны, где планировка сильно отличается;  
- Карта расположения текущих точек доступа. Особенно это актуально, когда ремонт свежий, и заказчик может наотрез отказаться проводить дополнительные монтажные работы в этой зоне (бывает и такое);  
- Карта зон, где покрытие не требуется. Тут же следует предложить и свой список, который у вас должен появиться после осмотра объекта;  
- Уточнить наличие пояснительной записки по проекту объекта, где чаще всего можно найти описание конструкций объекта, но тут шансы 50/50.  

### Результаты осмотра
Данные по материалам конструкций объекта нам получить не удалось, поэтому будем довольствоваться собственными изысканиями:  
- Внутренние стены: лист ГКЛ - Кирпич (120мм) - лист ГКЛ;  
- Внешние стены не сильно нас интересуют - вероятно, это железобетон;  
- Двери мы обнаружили самые разные, от деревянных полых до металлических;  
- В зонах с ремонтом используется некоторая нетиповая экзотика: стеклянные перегородки, металлические листы поверх кирпича;  
- Потолки вопросов не вызвали: плоские оштукатуренные и подвесного типа;  
- Колонны в расчет не брали, т.к их размеры в плане меньше 1м, и они внесут лишь небольшие корректировки в покрытие, которые полностью поглотятся прочими неопределённостями;  
- Приоритет по покрытию был отдан аудиториям, на технические помещения уровень сигнала допускался -78дБм;  
- Из покрытия были исключены следующие зоны: лестница парадного входа, межэтажные лестницы, лифтовые шахты, сан. узлы, несколько технических помещений;  
- Сформирован список существующих точек (по ~10 на этаж). Отличная опорная сеть для радиообследования.  

## Проводим замеры
### Гибридный метод обследования

В радиообследовании используется метод APoS (Access Point on Stick), или “точка доступа на палке”.  
Методику можно коротко описать следующими пунктами:  
- подходящая AP настраивается на рабочие частотные каналы и необходимую мощность (ту, по которой будем проектировать нашу сеть);  
- AP закрепляется на рамке, крепится к стойке и поднимается на высоту размещения. Питание поступает от АКБ, посредством PoE;  
- инженер по методике проводит измерения;
- после проведения части измерений (вплоть до уровня сигнала -80дБм) в ПО корректируется положение точки, и осуществялется ее «заморозка»;  
- AP переносится в другое место с целью уточнения ослабления, вносимого конструктивными особенностями объекта. Измерения повторяются во всех типовых областях.  

> **Заметка:** Замеры и первичный осмотр можно совместить, если позволяет время. В нашем случае мы разделили эти мероприятия.

В интернетах совмещение метода APoS и использование спец. ПО называют гибридным методом на основе APoS, а просто APoS именуется как легаси APoS. Не будем лезть в в дебри и будем называть метод без всяких гибридных приставок т.к это текущая реальнрость.  

Интерпретирует полученные результаты программа Ekahau AI Pro, которая представляет их в виде "тепловой" карты - градиентной карты покрытия.  

> **Совет:** Проверьте регион в настройках ПО, я последовал примеру Максима и выставил Сингапур. Захватывает наибольшее число каналов.

На самой AP нам понадобится настроить несколько параметров: SSID, TX power (мощность передатчика) и каналы в обоих диапазонах. Мощность приняли исходя из уже установленной на существующей точке Cisco 1602i, в том числе для удобства дальнейшего сравнения.  

С каналами в 2.4ГГц все понятно, у нас всего 3 “непересекающихся” канала с шириной канала 20МГц. С диапазоном 5ГГц сложнее, для тех же 20МГц мы имеем 17 непересекающихся каналов. (вообще 15, если не считать 144 и 165, с которыми не каждое клиентское устройство умеет работать).  

> В нашем случае был выбран канал из нижнего и верхнего диапазона 5ГГц т.к мы были сильно ограничены по времени.

Предварительно желательно провести измерения офсета выбранного клиентского устройства на каждом канале, относительно сайдкика, в данном случае. Нагляднее это делать в виде таблицы. Определить среднее значение офсета и на его основе выбрать соответствующий канал, который наиболее близок к среднему значению.  
Полученные данные будут полезны и для создания модели покрытия БСПД. Это не единственно верный подход, да и будет ли у вас время на верный подход?  

<figure>
    <img src="/assets/images/wireless_survey_2/offset.png"
         alt="offset">
    <figcaption>Пример таблицы значений и расчет diff, что и будет искомым офсетом относительно сайдкика.</figcaption>
</figure>

Какой офсет в итоге взять? Вещи обсуждаемые, как и большинстве тем касающихся радиообследования. Если устройств много, можно намерить каждое и взять нечто среднее от всех значений diff. Если устройство одно, то diff и будет нашим искомым значением.

> В нашем случае был выбран офсет generic smartphone в ПО Ekahau AI Pro = 10Дб. Это значение отнимается от полученных значений сайдкиком и уже с этим результатом отображается карта покрытия.

Настройка точки доступа:
- SSID: QTect-test
- Мощность сигнала:
	- 2.4ГГц: 10дБм
	- 5ГГц: 16дБм
- Каналы:
	- 2.4ГГц: 6 канал
	- 5ГГц: 40 канал (для нижней границы спектра), 157 канал (для верхней границы спектра)

### Основы работы с сайдкиком

Сайдкик - основной инструмент в нашем обследовании, разберемся с основными моментами работы с ним.  

Процедура простая и состоит из 4 шагов:
1.	Подключаем;
2.	Включаем;
3.	ХОДЬБА!;
4.	Анализируем.

В комплекте с сайдкиком поставляется два вида кабеля: USB-A to microUSB и USB-C to microUSB. Выбирайте любой.  

> **Внимание!** USB разъем у сайдкика нежен, поэтому обращайтесь с ним аккуратно. В противном случае, вам пригодится инструкция, [как заменить разъем](https://github.com/gcastle2007/Ekahau/blob/main/USB_recovery/README.md). 

Предполетная подготовка. Регулируем ремень таким образом, чтобы сайдкик был на уровне бедра. Носить его можно как на левой, так и на правой стороне. Есть вариант прицепить его на ремень [с помощью простого крепления от фотоаппарата](https://t.me/EvilWirelessChat/132082).  

Ноутбук берем в удобную руку, учитывайте расположение сайдкика. Если он с той же стороны, опустите чуть ниже, чтобы не цеплять рукой. Важно достичь удобства, ходить иногда приходится много.  

Включаем сайдкик, ждем некоторое время, пока оборудование не определится в программе.  

> **Внимание!** Кнопка включения - еще одно слабое место сайдкика. Давите аккуратней.

Все готово, можно приступать.  

![walking](/assets/images/wireless_survey_2/walking.png)
 
### Замеряем

В Ekahau Ai Pro 11 есть два метода сурвея: Continuous Survey и Stop-and-Go Survey. Stop-and-Go - легаси метод, медленный и неинформативный. От вас требуется выполнять остановку на каждом участке и ждать некоторое время (5 сек, но настраивается вплоть до нескольких минут), до завершения сбора информации. Этот метод мы не используем.  

Приведу наглядный пример, чтобы объяснить наверняка. Для этого мне понадобится всего два скриншота. В методе Continuous Survey сайдкик учитывает ВСЕ данные, которые принимает. Это видно по линиям между точками, где вы делали клики.  

![Continuous Survey](/assets/images/wireless_survey_2/Continuous_Survey.png)

А это метод Stop-and-Go. Тут сайдкик говорит всем маякам, данным и пр. "Неее, дружище, мне это не нужно", поэтому у вас есть всего лишь точки, где вы сделали клик и подождали 5 сек.

![Continuous Survey](/assets/images/wireless_survey_2/Stop-and-Go.png)

> Картинки взяты из официального [блога Ekahau](https://www.ekahau.com/blog/wi-fi-site-survey-methods-continuous-and-stop-and-go/).

Как вы уже догадались, сурвей будем выполнять методом Continuous Survey - он быстрее, хоть и несколько не точный т.к мы почти не останавливаемся во время прохода, а идем по заранее намеченной траектории. В этом случае от вас требуется некоторая сосредоточенность и ориентация в пространстве, чтобы не сбиться с траектории обхода.  

<figure>
    <img src="/assets/images/wireless_survey_2/neo.png"
         alt="neo">
    <figcaption>Полная сосредоточенность!</figcaption>
</figure>

> **Совет:** Когда вам нужно изменить направление, хорошей практикой является остановка / щелчок, поворот, щелчок и продолжить идти. Таким образом, вы не меняете скорость ходьбы и даете себе время сориентироваться. Под "щелчком" подразумевается клик ЛКМ на месте остановки, затем клик в том же месте после поворота в нужном направлении.

Не могу не упомянуть про метод Autopilot, им пользовался Максим. Если смотреть на это со стороны, то инженер выглядит как случайный прохожий с сумкой странного дизайна и смартфоном в руках. Не так давно этот способ вернули в РФ умельцы, обитающие в группе Ekahau-Rus & Wireless Co.  

<figure>
    <img src="/assets/images/wireless_survey_2/autopilot.png"
         alt="autopilot">
    <figcaption>Траектория обхода методом “автопилот” заметна невооруженным глазом. (На примере офиса из вебинара про Автопилот от Ekahau).</figcaption>
</figure>

Рекомендуется передвигаться короткими отрезками, от точки к точке (3 - 10м), сохраняя одинаковую скорость. По ходу обследования можно дополнять карту замеров, если остались "белые пятна". Сайдкик дополнит уже существующие данные.  

> **Совет:** Если запутались в карте, вас спасет комбинация Ctrl+Z (да, даже тут). Просто вернитесь на 1-2 точки назад, сделайте дополнительный клик, для уточнения позиции и продолжайте. Сам сурвей при этом не прерывается!

Участки рекомендуется проходить минимум дважды. Сначала сайдкиком к точке доступа, затем обратной стороной. Чаще всего это удобно совместить в одном проходе - сначала в одну сторону, затем обратно той же траекторией.  

Принцип APoS заключается в симуляции покрытия из нескольких AP с помощью одной AP. Для этого нам нужен инструмент, чтобы объяснить программе, как одна и та же AP может быть в разных местах. Для этого используется функция Freeze Access Point.

Предварительно удостоверьтесь, что данные присутствуют, и их достаточно. После заморозки AP дополнить замеры вокруг нее уже не получится, AP зазернится в катарсисе. Не забываем сохранять проект.  

<details>
	<summary><b>Все пропало, проект не сохранился!</b></summary>
        <p>В Ekahau Ai Pro 11 я встретил несколько неприятных багов, когда файл проекта просто сбрасывался и его размер становился 1Кб.<br>Тут я воспользовался логикой работы программы AutoCAD, где такая ситуация была частым явлением. В случае с Ekahau решение оказалось точно таким же!</p>
        <p>Ekahau делает автоматические бэкап-копии и хранит их по адресу C:\Users\Ваш пользователь\Ekahau Pro.temp в формате .bak.<br>Переименовываем в .esx и готово, можно пересохранить в нужное место и продолжить работать.<br>Но лучше приучите себя к технике мануального сохранения, а подобные способы оставьте на черный день.</p>
</details>

## Анализируем данные

Теперь переходим к анализу. По завершению сурвея у вас будет файл .esx, который содержит весь объем проведенных замеров. Чтобы оценить полученные результаты, нам потребуется:  
- четко видеть цветовую градацию покрытия нашего SSID, для этого нужно настроить цветовую палитру (та, что по умолчанию, не всегда годится);
- иметь возможность посмотреть силу сигнала в дБм (с применением офсета);
- понимать, какие AP участвуют в этом процессе, используя фильтры.

Начнем с цветового представления. По умолчанию, разбивка по цветам слишком частая, нам не обязательно видеть большое количество оттенков желтого в границе от 0 до -50 дБм.  

Исправим это. По щелчку ЛКМ на легенде, видим много настроек, для наших целей понадобится всего две:  
- Adjustable color range
- Legend Range

<figure>
    <img src="/assets/images/wireless_survey_2/colors.png"
         alt="colors">
    <figcaption>Для наших целей такой настройки достаточно.</figcaption>
</figure>

Затем настроим визуализацию от лица клиентского устройства, а не сайдкика.  
В настройках легенды есть параметр *View as Mobile Device*. Это усредненный параметр офсета, который отнимает от текущего уровня замеров 10 дБм, имитируя мобильное устройство.  

Чтобы добавить собственный офсет, примените заклинание CTRL+ЛКМ на Легенду. Увидите уже знакомое меню, среди прочего, теперь есть выбор пресетов для офсета клиентского устройства.  

![Custom Offset](/assets/images/wireless_survey_2/custom_offset.png)

> **Совет:** Как уже упоминалось выше, офсет клиентского устройства нужно замерять отдельно, по самому слабому устройству в сети.

Почти закончили, осталось отфильтровать из всего массива точек доступа нашу сеть по известному SSID, чтобы карта покрытия учитывала только нужные нам AP. Основной фильтр находится внизу интерфейса.  

![Filter AP](/assets/images/wireless_survey_2/filter_ap.png)

> **Совет:** Чтобы увидеть покрытие конкретной точки, ее достаточно выбрать на карте или в списке всех AP.

### Первый взгляд на результаты

После проведения замеров, первое, что вы сделаете - бегло проанализируете результаты. Сразу к детальному анализу переходить рано. Как мы это делали, для наглядности, я покажу разницу на примере четырех визуализаций.  

<figure>
    <img src="/assets/images/wireless_survey_2/before_2.4.png"
         alt="before_2.4">
    <figcaption>Для 2.4ГГц.</figcaption>
</figure>

<figure>
    <img src="/assets/images/wireless_survey_2/before_5.4.png"
         alt="before_5.4">
    <figcaption>Для 5ГГц.</figcaption>
</figure>

Так мы видим карту покрытия сразу после замеров, без дополнительных манипуляций.  

Сайдкик собирает абсолютно все данные вокруг него, но в итоговом результате мы, по какой-то причине, видим на карте автоматически размещенные точки доступа. Сразу может возникнуть вопрос, как ПО Ekahau решает, каким точкам суждено оказаться на конкретном этаже, в конкретной точке плана?  

Этим занимается некий алгоритм, в программе за это отвечает функция Auto-Place APs, находится она `File->Preferences->Auto-place APs`. Ekahau Ai Pro, после измерений, попытается определить местоположение только тех точек доступа, которые имели достаточный уровень сигнала (уровень сигнала в одном или нескольких местах превысил -50 дБм). Это делается для того, чтобы избежать неточного расположения точек доступа и загромождения карты путем размещения всех точек доступа. Точно ли это описание алгоритма? Конечно нет, я понятия не имею как оно внутри на самом деле работает, открытых источников об этом нет.  

Вернемся к визуализациям и посмотрим на те же области и диапазоны, но уже с настройками цвета, офсета и выбранной AP Qtech:  
 

<figure>
    <img src="/assets/images/wireless_survey_2/after_2.4.png"
         alt="after_2.4">
    <figcaption>Для 2.4ГГц.</figcaption>
</figure>

<figure>
    <img src="/assets/images/wireless_survey_2/after_5.4.png"
         alt="after_5.4">
    <figcaption>Для 5.4ГГц.</figcaption>
</figure>

Такой формат больше подходит для дальнейшей обработки данных.  

Разобравшись с настройками представления, рассмотрим визуализации подробней.  

Текущая визуализация **Signal Strength** - это представление RSSI в виде абсолютного значения, т.е фактический уровень сигнала, полученный сайдкиком от AP. Чем ближе к 0дБм, тем лучше уровень сигнала.  

RSSI - это величина, которую нам отобразит драйвер беспроводного адаптера по каким-то, одному ему известным, законам, а Signal Strength - это фактические значения наводимой в спектроанализаторе сайдкика мощности. Обе величины абсолютные, потому что измеряются в дБм.  

Если развернуть подробнее, RSSI - это уровень в дБм, который был принят на приёмник адаптера, прошёл длинный путь от него через какую-то логику в драйвер и оттуда - в ОС и наш показометр в Свойствах соединения, например. А вот по какому принципу эта величина пришла такой, какой пришла - мы не можем знать, потому что вся дорога для нас - черный ящик, да и не исключена вероятность, что драйвер взял и тупо наврал, чтобы нас порадовать более высоким значением принимаемого сигнала.  

На легенде пороговое значение выставлено в -70 дБм, Этот порог - наш, как инженеров, баланс между качеством связи, емкостью всей сети и стоимостью проекта. Такой уровень сигнала, при соотношении сигнал/шум >20-25 дБ и ширине канала 20МГц, обеспечивает отличное качество связи и максимальную канальную скорость ([MCS 6-7](https://d2cpnw0u24fjm4.cloudfront.net/wp-content/uploads/802.11n-and-802.11ac-MCS-SNR-and-RSSI.pdf)) подключения на современных устройствах. При отсутствии помех, источником которых, чаще всего, служит пересечение каналов AP своей же сети, возможна высокая фактическая скорость передачи данных в сети.  

> Важным будет отметить, пограничные значения - большой и актуальный вопрос для обсуждения.  

> *За уточнение по RSSI и MCS спасибо Андрею Парамонову*  

<figure>
    <img src="/assets/images/wireless_survey_2/RSSI.png"
         alt="RSSI">
    <figcaption>Красный цвет - RSSI для оранжевой зоны, синий цвет - RSSI для желтой зоны.</figcaption>
</figure>

>  **Совет:** Окно с информацией появляется автоматически, если удерживать курсор на одном месте пару секунд или нажать хоткей – T.

> Тема MCS и скорости работы Wi-Fi выходит за рамки статьи. Рекомендую к изучению две статьи от коллег:
-	[Реальная скорость Wi-Fi (на предприятиях)](https://habr.com/ru/articles/431404/) 
-	[Почему Wi-Fi не будет работать, как планировалось, и зачем знать, каким телефоном пользуется сотрудник](https://habr.com/ru/company/comptek/blog/427575/)

В правой половине интерфейса есть пара полезных вкладок, которые пригодятся при анализе, Access Point и Surveys. В Access Points, как ни странно, будут отображаться все точки доступа (в зависимости от фильтров):  

<figure>
    <img src="/assets/images/wireless_survey_2/gui_ap.png"
         alt="GUI AP">
    <figcaption>Для справки, на территории объекта Ekahau обнаружил около 750 AP (смартфоны, AP и т.п.</figcaption>
</figure>

Вкладка Surveys позволяет манипулировать результатами обхода. Сейчас это не так важно, можно ознакомиться под спойлером.  

<details>
	<summary><b>Сравнение замеров конкретной зоны в разные промежутки времени.</b></summary>
        <p>В закладке Surveys мы увидим все проходы с привязкой ко времени и двум видам замеров: Primary и Secondary (разобраться подробнее)</p>
        <p><img src="/assets/images/wireless_survey_2/surveys.png" alt="GUI Surveys"></p>
        <p>Удобная функция анализа кроется под параметрами Primary и Secondary. Работает это в связке с визуализацией Difference in Signal Strength.</p>
        <p><strong>Принцип работы:</strong> У вас есть два замера одной и той же области в разное время, выставляем более ранние измерения как Primary, вторые - как Secondary.
        Цветовой градацией будут помечены области, где замеры различаются. Если навести на них курсор, будет показано значение, на сколько дБм в ту или иную сторону изменился RSSI.</p>
        <p>Почему по два замера? По одному на диапазон - 2.4 и 5 ГГц. Это очень даже удобно при анализе. </p>
        <p><img src="/assets/images/wireless_survey_2/compare_surveys.png" alt="Compare Surveys"></p>
        <p>Визуализация так же основана на цветовом градиенте: </p>
        <p><img src="/assets/images/wireless_survey_2/Legend_!.png" alt="Surveys legend"></p>
        <p>На картинке мы видим, что у меня в зоне обследования другого этажа есть два прохода по одной местности.
        Зеленым цветом обозначен – Primary, бежевым – Secondary.
        Все, что выше зеленого – показывает, что в этой зоне сигнал secondary был сильнее, чем primary, то, что ниже, соответственно – хуже. 
        Для примера, на картинке показана информация по области бирюзового цвета, в которой сигнал оказался слабее на 6дбм при вторичном замере. Это не 100% гарантия что оно так на самом деле т.к есть множество факторов, которые могли повлиять на результат. При APoS нам важно не только качество замеров, но еще и достаточное их количество.</p>
</details>

### Пример анализа

Можно сразу посмотреть другие визуализации, но предлагаю сделать это в контексте следующего режима - **Inspect**.  

Тут мы можем проследить весь путь обхода и «встать» на любую из доступных точек. Это поможет детальнее изучить происходящее в РЧ среде в отдельно взятый отрезок времени и на всем пути в целом.  

Для демонстрации, я возьму интересный (с высоты моего скромного опыта) момент, который хорошо способен проиллюстрировать полезность Inspect и осветить интересный вопрос по интерпретации шума в Ekahau.  

Возьмем небольшой отрезок пути в холле 2-го этажа и посмотрим его основные параметры (1)  

<figure>
    <img src="/assets/images/wireless_survey_2/example_1.png"
         alt="example_1">
    <figcaption>Все вроде бы в порядке, но есть вопросы к SNR.</figcaption>
</figure>

Чтобы понять что происходит, будем действовать по порядку. Нам необходимо проверить несколько параметров из указанных на скриншоте и один смежный:  
- Signal Strength (уровень сигнала);
- SNR (отношение сигнал/шум);
- Noise (Шум);
- Channel interference (пересечение каналов).

С signal strength мы ознакомились выше, здесь с ним все в пределах нормы.  

**SNR** (Signal to noise ratio), или соотношение сигнал/шум, в нашей замечательной, казалось бы, картине, хромает на обе ноги. Смежный с ним параметр - Noise (шум), также важен, о нем ниже.  

> **Совет:** Можно переключать визуализации и в режиме Inspect. Для предоставления информации по визуализации предусмотрено дополнительное окно Visualization details.  

SNR рассчитывается по формуле SNR = signal strength (RSSI) - noise. Более высокие значения означают, что уровень сигнала выше уровня шума, а значит, есть возможность использовать более сложную модуляцию, что чаще всего ведет к бОльшим скоростям (MSC).  

Например, голосовая связь ожидает, что отношение сигнал/шум (SNR) составит минимум 25 дБ.  

Так выглядит общий пример расчета:  

SNR = RSSI - Noise  
-   RSSI: -67 дБм
-   Noise: -92 дБм

RSSI - Noise = -65 дБм - (-80 дБм) = 25 дБ

<figure>
    <img src="/assets/images/wireless_survey_2/SNR.png"
         alt="SNR">
    <figcaption>Визуально закрепим описанное выше касаемо SNR.</figcaption>
</figure>

Наиболее распространенным источником шума являются межканальные помехи (CCI) от других устройств Wi-Fi, что мы здесь и наблюдаем.  

Переключимся на визуализацию SNR, чтобы понять, насколько плохи дела:  

<figure>
    <img src="/assets/images/wireless_survey_2/example_2.png"
         alt="example_2">
    <figcaption>Что-то тут явно происходит, SNR на уровне 10-17 дБ, при желаемом уровне >=25 дБ.</figcaption>
</figure>

Теперь попробуем уточнить запрос и посмотрим одну из основных составляющих SNR - Noise (Шум).  

**Noise** (Шум) - определенное значение сигнала, рассчитанное на основе совокупности существующих сигналов. Тепловой/космический/атмосферный шумы и другие природные источники.  

В дополнение к тепловому шуму помехи и шумы могут быть вызваны радиоприемниками Wi-Fi (как в вашей сети, так и в других сетях), беспроводными телефонами, радионянями, видеоустройствами, устройствами Bluetooth, ZigBee, микроволновыми печами, радарами, радиопомехами, тяжелой техникой и бесчисленным множеством других устройств, а также самим принимающим устройством.  

Посмотрим, наконец, на визуализацию и посмотрим, что было с параметром шума в этой области:

<figure>
    <img src="/assets/images/wireless_survey_2/example_3.png"
         alt="example_3">
    <figcaption>В этой зоне ОЧЕНЬ шумно!</figcaption>
</figure>

**Проблема:** Что-то шумит на 11 канале, отчего параметр Noise (при его нормальном значении -90 до -95 дБм. по всему объекту) упал до -57дБм!  

На этом этапе не обязательно сразу бежать с анализатором спектра на объект. Не исключено, что в этот момент одна из ближайших точек активно обменивалась данными, но это так же может быть и пересечение каналов от на близкорасположенных точках.  

Возьмем этот случай в качестве примера, чтобы посмотреть еще одну интересную фичу Ekahau - спектральный анализ.  

Но сначала, немного о цифре, которую мы увидели на визуализации. Цифра, представленная в визуализации - сигнал, интерпретированный сетевой картой cайдкика как шум. На самом деле представляет из себя комплексный параметр. Что это значит?  

*За наводку спасибо Максиму Гетману*

Исходя из определения, шум - совокупность сигналов. Сайдкик измеряет этот параметр следующим образом:  
- Адаптер Sidekick в неразборчивом (promiscuous) режиме прослушивает 105 мс на каждом канале. В течение этого времени он ищет любую преамбулу и пытается синхронизироваться с ней (Signal Detect, SD)
- А дальше есть варианты:
    - если может синхронизироваться – он продолжает прослушивать тело пакета и проверяет CRC32 FCS;
    - если все в порядке – некоторый параметр шума все равно снимается, если канал не забит настолько, что это будет только RSSI;
    - если FCS неверен – это “сломанный” фрейм – считается как шум, а уровень шума является фактическим RSSI;
    - если адаптер слышит какую–либо радиочастотную энергию (что-либо, отличное от 802.11) - РЧ энергия тоже интерпретируется как шум.

Вывод напрашивается следующий: Значения шума по Ekahau не релевантно использовать в качестве расчетного значение, например, для расчета SNR. (захотелось вам, например, проверить программу расчетом). Получите значительные расхождения, т.к наверняка невозможно сказать, что именно было интерпретировано в шум.  

> **Совет:** Если в карте шума наблюдаются подобные аномалии (резкие падения уровня шума), учитывайте, что видите интерпретированные данные и всегда смотрите на подозрительные аномалии в спектре. Иными словами – задач, которую мы взяли для примера – сферический конь в вакууме.

## Помехи и спектр
### Практическая теория, взгляд дилетанта

**Опыт в анализе спектра у меня небольшой, но я постарался подготовиться. Если где-то не получилось, прошу конструктивной критики и вопросов в комментариях. Буду разбираться.**  

![Spectrum](/assets/images/wireless_survey_2/spectrum.png)

Спектральный анализ - комплексная и сложная тема. Я затрону лишь небольшую часть теории, достаточную, чтобы хотя бы немного понимать, что мы видим на спектре в Ekahau. Серьезные теоретические вещи я оставлю знающим людям.  

> Вот, например, обстоятельный [плейлист](https://www.youtube.com/playlist?list=PLO2lqCK7WyTBlUJY6DD70EekoQgrRmp5c) по общей теории спектра, найденный на просторах youtube.

Для начала, рекомендую ознакомиться с [базой](https://habr.com/ru/companies/timeweb/articles/677452/), если вы совсем не понимаете что происходит. В своей компетенции я лишь постараюсь рассказать, как работать со спектром в Ekahau. Для этого нужно понимать, куда смотреть.  

Смотреть мы будем на следующие параметры:
-	частотная и временная область;
-	плотность (density);
-	цикл развертки (sweep cycle).

Познавать предлагаю сразу на примере в Ekahau Ai Pro, а после вернемся к нашему примеру.  

![Spectrum](/assets/images/wireless_survey_2/gui_spectrum.jpg)

Частотная область (1), или по-другому FFT (БПФ) - анализатор спектра улавливает радиочастотную энергию во временной области и преобразует информацию в частотную область с использованием алгоритма БПФ. Иными словами, мы видим амплитуду сигнала.  

БПФ (Быстрое преобразование Фурье) - это усовершенствованный алгоритм ПФ (Преобразование Фурье), который дискретизирует сигнал в течение определенного периода времени или пространства, делит его на частотные составляющие.  

> Подробней про БПФ - добро пожаловать на очередную [статью](https://habr.com/ru/articles/196374/) коллеги с Хабра.

<figure>
    <img src="/assets/images/wireless_survey_2/FFT.gif"
         alt="FFT">
    <figcaption>БПФ в Ekahau.</figcaption>
</figure>

Понимание расширенных спецификаций анализаторов спектра обычно не требуется для эффективного устранения неполадок. Но понимание, что такое цикл развертки (sweep cycle), будет полезно.  

Простыми словами, развертка - это то, сколько времени требуется для сканирования определенного диапазона за единицу времени. В анимации выше, используется real-time sweep cycle с частотой обновления - 1 сек. Также возможно отображение максимальных пиков и среднее значение сигнала.  

Водопад (2), который вы часто будете использовать, наоборот, представляет данные в виде каскада разверток, одной строкой. Это, если можно так выразиться, история обнаруженных сигналов.  

На водопаде можно наблюдать несколько полезных параметров:  
-	рабочий цикл (Duty Cycle) - процент времени, сколько передатчик активен;
-	утилизация полосы (Utilization) - процент времени использования частоты обнаруженным сигналом.

> Оставлю [видео](https://www.youtube.com/watch?v=KAYEo_V9Gqc&ab_channel=CWNPTV) с канала CWNPTV для лучшего понимания временнЫх параметров спектра.

<figure>
    <img src="/assets/images/wireless_survey_2/watterfall.gif"
         alt="watterfall">
    <figcaption>Водопад” в Ekahau.</figcaption>
</figure>

Представить картину целиком нам поможет рисунок ниже:  

<figure>
    <img src="/assets/images/wireless_survey_2/complex.jpg"
         alt="complex">
    <figcaption>f - частотная область, T - временная область, 1 - БПФ и 2 - “Водопад”, соответствуют картинке выше.</figcaption>
</figure>

> Анализатор спектра Ekahau не отображает график временной области с направления (T). Те самые синусоиды.

Для удобства интерпретации почти мгновенных сигналов используется параметр плотности (density) сигнала - основное представление БПФ в Ekahau, показывающий, как часто сайдкик видит РЧ сигнал (в цветовом представлении). Используется зеленый цвет для обозначения низкого, “редкого” уровня использования, а красный / черный - для обозначения высокого / очень высокого (“очень частого”) уровня использования.  

![Density](/assets/images/wireless_survey_2/density.gif)

Обнаруженные AP собираются в общий список, который затем удобно фильтровать (3). В закладке Channels мы можем увидеть утилизацию каналов в реальном времени (в %), пересечения каналов и шум.  

<figure>
    <img src="/assets/images/wireless_survey_2/speedtest.gif"
         alt="speedtest">
    <figcaption>SpeedTest в диапазоне 5ГГц.</figcaption>
</figure>

### Сигнатуры

Сигналы стандарта 802.11 имеют четкую сигнатуру, которой соответствует своя спектральная маска. Спектральные маски различаются в зависимости от модуляции. Основная задача маски - определять допустимое распределение мощности по каналу.  


Виды спектральных масок, где представлены несколько стандартов передачи 802.11:  
<figure>
    <img src="/assets/images/wireless_survey_2/spectrum_mask.png"
         alt="speedtest">
    <figcaption>Картинка взята из [исследования](https://ieeexplore.ieee.org/document/6334846) Interference measurements in an 802.11n Wireless Mesh Network testbed (автор: Ted H. Szymanski/McMaster University).</figcaption>
</figure>

Несколько примеров, как выглядят сигнатуры сигнала Wi-Fi:
802.11b - использует DSSS модуляцию (устарел):

![802.11b](/assets/images/wireless_survey_2/802.11b.gif)

В спектроанализаторе Ekahau хватает разрешающей способности, чтобы увидеть, например, поднесущие OFDM сигнала:  

![OFDM](/assets/images/wireless_survey_2/OFDM.gif)

OFDM использует каналы шириной 20 МГц, содержащие 52 поднесущие; 4 для пилотной передачи и 48 для передачи данных. Центр содержит одну нулевую поднесущую.  

![subcarrier](/assets/images/wireless_survey_2/subcarrier.png)

Выше мы посмотрели на Wi-Fi сигнал, а вот так выглядит спектр от некоторых Не-Wi-Fi устройств.

![microwave](/assets/images/wireless_survey_2/microwave.gif)
Микроволновка, детальнее на [видео](https://www.youtube.com/watch?v=pBAZrZlUhEY) с youtube-канала Максима.  

![jammer](/assets/images/wireless_survey_2/jammer.gif)
Джаммер (глушилка), нагляднее в еще одном [видео](https://www.youtube.com/watch?v=LjRbo5NoH5Q&ab_channel=MaksimGetman) Максима.  

Другие виды частотных сигнатур Wi-Fi и не Wi-Fi устройств хорошо показаны в [обстоятельной статье](https://skomplekt.com/kak-najti-i-ubrat-pomekhi-meshayushchie-rabote-wifi/#:~:text=%D0%A1%D0%B5%D1%82%D0%B8%20Wi%2DFi%20%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%D1%8E%D1%82%20%D0%B2,%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D1%8C%D1%81%D1%8F%20%D0%B8%20%D0%B4%D1%80%D1%83%D0%B3%D0%B8%D0%BC%D0%B8%20%D0%B1%D0%B), с картинками спектра и пояснениями.  

*Гифки некоторых сигналов я нашел в [блоге](https://howiwifi.com) Джереми Шарпа.*  

### Пример спектрального анализа

Перед тем как детально изучать спектр в реальном времени, удобнее сначала проанализировать данные радиообследования, особенно если объект крупный. Спектр так же записывается сайдкиком по ходу радиообследования.  

На основе такого анализа вы, конечно, не получите ответы на все вопросы, но точно сможете предположить наличие проблемы и при следующем посещении объекта уделить больше времени аномальным зонам - и выяснить, насколько верны ваши предположения.  

Вооружившись знаниями, изучим спектр нашего примера с проблемой SNR. Если встать на поинт обхода, можно посмотреть записанные данные спектра:  

![example_4](/assets/images/wireless_survey_2/example_4.png)

Синим я обозначил SSID от точки доступа Cisco 1602i - AP вещает на 10-м канале в 20МГц (над настройкой каналов в диапазоне 2.4ГГц, очевидно, не сильно заморачивались).  

Красным обозначил no_name AP, которая вещает на 11 канале, также в 20МГц.  

**Основное предположение**: пересечение каналов с соседским устройством + высокая утилизация спектра в момент замеров области.  

Посмотрим как сайдкик видел это устройство. Достаточно щелкнуть на трапециевидное отображение уровня сигнала на спектрограмме, и точка подсветится на карте:  

![no name ap](/assets/images/wireless_survey_2/noname_ap.png)

В момент измерения, синяя AP (Cisco) активно утилизировала эфир в диапазоне 2.4ГГц. В тот же момент, неизвестная AP должна испытывать проблемы в этой части эфира, т.к 10 и 11 канал сильно пересекаются (всего по 5 свободных друг от друга МГц). Из-за сильного пересечения поднесущих, одна точка не может правильно декодировать заголовок кадра 802.11, из-за чего не срабатывает CSMA/CA, и SD превращается в ED (Energy Detect). Это типичная межканальная помеха (Adjacent Channel Interference, ACI). Что такое SD и ED я пока не готов рассказывать сам, поэтому пока лишь [полезная ссылка](https://www.extremenetworks.com/resources/blogs/what-is-a-clear-channel-assessment-cca).  

![ACI](/assets/images/wireless_survey_2/ACI.png)

> **Важно:** Пока нет детальных замеров зоны с обнаруженной аномалией, данные замеров SNR или Шума могут давать погрешности.

Если попробуем посчитать наш пример:

RSSI - Noise = SNR

-   RSSI: -61 дБм
-   Noise: -57 дБм

RSSI - Noise = -61 дБм - (-57 дБм) = -4дБ

Как видим, присутствует приличная погрешность в сравнении с показаниями Ekahau Ai Pro.  

> Отрицательный знак в SNR - сигнал слабее шума (на 4дБ в нашем случае), положительный знак - сигнал сильнее шума.  

Такие расчеты получились в том числе потому, что мы попытались посчитать уровень SNR в конкретной точке покрытия, без проведения уточняющих замеров, также следует учитывать описанный выше нюанс, как сайдкик измеряет шум.  

Посчитал ли я правильно? Верно ли понял смысл? А имеет ли смысл вообще считать в таких случаях? Эти и другие вопросы можно задать в комментариях. 

Вне зависимости от ответов, картина остается прежней: взятый пример – гипотетически возможная проблема, где уровень шума высок, уровень SNR низок, поэтому качество сигнала Wi-Fi ухудшается, а скорость передачи данных снижается.  

![ACI](/assets/images/wireless_survey_2/Throughput.png)

В визуализации Data Rate и Throughput можно узнать о сигнале чуть больше, но это уже совсем другая история.  

В конечном итоге, предположим, что мы определили некоторую аномалию как потенциальную помеху. Для выявления источника на местности релевантно использовать метод деления на квадранты и измерения уровня сигнала в каждом из них.  

Выявив квадрант с наиболее сильным сигналом, снова разделите его на четыре части и проведите измерение в каждой из них. Уменьшив район поиска, методично осматриваем помещения и расспрашиваем сотрудников. После нахождения источника предпринимаем необходимые меры по его устранению. Если устранить невозможно (например, это радио-трубка, принадлежащая другой компании), то перенастраиваем ближайшие к помехе AP на другие каналы.  

> Пообщавшись с опытными коллегами, выяснилось - в реальной практике проблемы в БПСД крайне редко замыкаются на проблемах спектра. Все описанное выше преследовало ознакомительные цели в связке с моим любопытством к теме.

На этом пока и закончим. Получился некоторый собирательный образ того опыта, который мне понадобилось уложить в голову за время проекта. Далее еще точно допишу про моделирование и нюансы работы с ПО Ekahau, а так же попробую поведать кустарный замер точки Qtech в чистом поле и историю с отсутствием диаграммы направленности у нашей точки доступа. Спасибо, что дочитали до конца.  

<p></p>
<hr>
<h2>Хочешь обсудить тему?</h2>
С вопросами, комментариями и/или замечаниями, приходи в [чат](https://t.me/netautomationarea) или подписывайся на [Telegram-канал](https://t.me/+Jeoaxn2kby4zMWUy).